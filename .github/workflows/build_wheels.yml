name: Build
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}-${{ github.event.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths: 
      - 'src/**'
      - 'tests/**'
      - 'LICENSE'
      - 'CMakeLists.txt'
      - 'pyproject.toml'
      - '.github/workflows/build_wheels.yml'
  push:
    branches:
      - main
    paths: 
      - 'src/**'
      - 'tests/**'
      - 'LICENSE'
      - 'CMakeLists.txt'
      - 'pyproject.toml'
      - '.github/workflows/build_wheels.yml'

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include: 
          - name: "Linux x64 (manylinux)"
            os: ubuntu-latest
            cibw_build: "*-manylinux*"
          # - name: "Linux arm (manylinux)"
          #   os: ubuntu-24.04-arm
          #   cibw_build: "*-manylinux*"
          - name: "Linux x64 (musllinux)"
            os: ubuntu-latest
            cibw_build: "*-musllinux*"
          # - name: "Linux arm (musllinux)"
          #   os: ubuntu-24.04-arm
          #   cibw_build: "*-musllinux*"
          - name: "Windows x64"
            os: windows-latest
          # - name: "Windows arm"
          #   os: windows-11-arm64
          - name: "macOS Intel"
            os: macos-13
          - name: "macOS Apple Silicon"
            os: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/cibuildwheel
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - uses: ilammy/msvc-dev-cmd@v1
        if: startsWith(matrix.os, 'windows-')
        with:
          arch: ${{ matrix.os == 'windows-latest' && 'x64' || matrix.os == 'windows-11-arm' && 'arm64' }}

      - name: MacOS OpenMP
        if: startsWith(matrix.os, 'macos-')
        run: brew install libomp

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.1.3
        env:
          CIBW_BUILD: ${{ matrix.cibw_build || '*'}}
          CIBW_ENVIRONMENT_PASS_LINUX: "PIP_CACHE_DIR"
          CIBW_ENVIRONMENT_PASS_MACOS: "PIP_CACHE_DIR OpenMP_ROOT MACOSX_DEPLOYMENT_TARGET"
          CIBW_ENVIRONMENT_PASS_WINDOWS: "PIP_CACHE_DIR"
          PIP_CACHE_DIR: ${{ runner.os == 'Linux' && '~/.cache/pip' || runner.os == 'macOS' && '~/Library/Caches/pip' || '~\AppData\Local\pip\Cache' }}
          OpenMP_ROOT: ${{ matrix.os == 'macos-latest' && '/opt/homebrew/opt/libomp/' || matrix.os == 'macos-13' && '/usr/local/opt/libomp' || '' }}
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.os == 'macos-latest' && '14.0' || matrix.os == 'macos-13' && '13.0' || '' }}

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.name }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl
  
  make_release:
    needs: build_wheels
    environment: pypi
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Extract version
      id: version
      run: |
        TAG=${{ github.ref }}
        VERSION=${TAG#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
    
    - uses: actions/checkout@v4
    
    - uses: actions/download-artifact@v4
      with:
        pattern: cibw-*
        path: dist
        merge-multiple: true

    - name: Build SDist
      run: python -m build --sdist

    - uses: pypa/gh-action-pypi-publish@release/v1

    - name: Create Github Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      run: |
        gh release create -R JelmerBot/plscan -t "Version ${{ steps.version.outputs.version }}" -n "**Full Changelog**: https://github.com/JelmerBot/plscan/commits/${{ steps.version.outputs.tag }}" "${{ steps.version.outputs.tag }}" dist/*.whl dist/*.tar.gz

  